<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta property="og:title" content="青空文庫読み上げ">
                <meta property="og:description" content="しゃべる9x9の表だよ、表の数字の箇所を押してみよう">
                <meta property="og:image" content="https://freddiefujiwara.com/kuku/images/demo.gif">
                <meta property="og:url" content="https://freddiefujiwara.com/kuku/">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="twitter:card" content="summary_large_image">
                <meta name="twitter:site" content="@freddiefujiwara">
                <meta name="twitter:creator" content="@freddiefujiwara">
                <meta name="twitter:title" content="しゃべる99表">
                <meta name="twitter:description" content="しゃべる9x9の表だよ、表の数字の箇所を押してみよう">
                <meta name="twitter:image" content="https://freddiefujiwara.com/kuku/images/twitter.jpg">
		<link rel="manifest" href="manifest.json">
		<link rel="icon" href="icon/icon-32x32.png" />
		<style>
@import url('https://fonts.googleapis.com/css?family=Roboto:300');
* {
	box-sizing: border-box;
	font-family: 'Roboto', sans-serif;
}
p.done {
	color:white;
	background-color:black;
			}
p.reading {
	background-color:yellow;
			}
		</style>
		<title>青空文庫読み上げ</title>
	</head>
	<body>
		<a href="javascript:start()">start</a>
    <div id="contents"></div>
		<audio id="audio" src=""></audio>
	        <script type="text/javascript">
let data = {};
let index = 0;
const audio = document.getElementById("audio");
const start = async () => {
  data = JSON.parse(await (await fetch("https://asia-northeast1-freddiefujiwara.cloudfunctions.net/aozora")).text());
  document.getElementById("contents").innerHTML = "<p>" + data.contents.join("</p><p>") + "</p>";
  audio.addEventListener('ended', async () => {
    index++;
    const c = data.contents[index];
    if (index < data.contents.length) {
      audio.src = `https://asia-northeast1-freddiefujiwara.cloudfunctions.net/tts?mp3=mp3&lang=ja&message=${encodeURIComponent(c)}`;
      audio.play();
      document.getElementById("contents").innerHTML = document.getElementById("contents").innerHTML.replace(new RegExp(`<p>${c}`), `<p class="reading">${c}`);
      await new Promise(resolve => setTimeout(resolve, c.length * 0.35 * 1000));
      document.getElementById("contents").innerHTML = document.getElementById("contents").innerHTML.replace(new RegExp(`<p class="reading">${c}`), `<p class="done">${c}`);
    }
  });
};
            </script>
	</body>
</html>
